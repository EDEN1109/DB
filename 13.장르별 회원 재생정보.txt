SET FEEDBACK OFF

TTITLE '장르별 재생정보'
COLUMN SGID HEADING '가수|아이디'
COLUMN NUM HEADING '음원|번호'
COLUMN TRACK HEADING '음원명' 
COLUMN TNUM HEADING '음원재생|횟수' FORMAT 999,999,999,999
COLUMN MALE HEADING '남성재생|횟수' FORMAT 999,999,999,999
COLUMN FEMALE HEADING '여성재생|횟수' FORMAT 999,999,999,999
COLUMN TAVGAGE HEADING '평균|연령대' FORMAT 90.00
COLUMN PLNUM HEADING 'PLAYLIST|추가횟수' FORMAT 999,999,999,999
BREAK ON SGID

WITH PLAYM AS (SELECT PLAY_NUM, COUNT(*) AS CM
		FROM PLAY, MUSICAPP_USER
		WHERE MUSICAPP_USER.SEX = 'M'
		AND MUSICAPP_USER.USER_ID = PLAY.USER_ID
		GROUP BY PLAY_NUM),
PLAYF AS (SELECT PLAY_NUM, COUNT(*) AS CF
		FROM PLAY, MUSICAPP_USER
		WHERE MUSICAPP_USER.SEX = 'F'
		AND MUSICAPP_USER.USER_ID = PLAY.USER_ID
		GROUP BY PLAY_NUM),
PLTOTAL AS (SELECT LIST_NUM, COUNT(*) AS CL
		FROM PLAYLIST, SOUNDTRACK
		WHERE SOUNDTRACK.NUM = PLAYLIST.LIST_NUM
		GROUP BY LIST_NUM),
TAVG AS (SELECT PLAY_NUM, AVG(MONTHS_BETWEEN(SYSDATE,MUSICAPP_USER.BORN_DATE)/12) AS AVGAGE
	FROM PLAY, MUSICAPP_USER
	WHERE PLAY.USER_ID = MUSICAPP_USER.USER_ID
	GROUP BY PLAY_NUM)
SELECT SINGER.SINGER_ID AS SGID, SOUNDTRACK.NUM AS NUM, NVL(SOUNDTRACK.NAME,'업로드한 음원이 없습니다.') AS TRACK, NVL(PLAYM.CM,0)+NVL(PLAYF.CF,0) AS TNUM, NVL(PLAYM.CM,0) AS MALE, NVL(PLAYF.CF,0) AS FEMALE, NVL(AVGAGE,0) AS TAVGAGE, NVL(PLTOTAL.CL,0) AS PLNUM
FROM SOUNDTRACK, SINGER, PLAYM, PLAYF, TAVG, PLTOTAL
WHERE SOUNDTRACK.NUM = PLAYM.PLAY_NUM(+)
AND SOUNDTRACK.NUM = PLAYF.PLAY_NUM(+)
AND SOUNDTRACK.NUM = TAVG.PLAY_NUM(+)
AND SOUNDTRACK.NUM = PLTOTAL.LIST_NUM(+)
AND SOUNDTRACK.GENRE = '&장르'
AND SINGER.SINGER_ID = SOUNDTRACK.UPLOAD_SINGER(+)
ORDER BY SGID, NUM
/

TTITLE OFF
CLEAR COLUMNS
CLEAR BREAK