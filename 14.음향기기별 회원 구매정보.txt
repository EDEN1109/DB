SET FEEDBACK OFF

TTITLE '음향기기별|구매자 정보'
COLUMN PNAME HEADING '제품명'
COLUMN CATEGORY HEADING '제품|카테고리'
COLUMN BNUM HEADING '구매자|수' FORMAT 999,999,999,999
COLUMN MNUM HEADING '남성 수' FORMAT 999,999,999,999
COLUMN FNUM HEADING '여성 수' FORMAT 999,999,999,999
COLUMN TAVGAGE HEADING '평균|나이대' FORMAT 90.00

WITH BUYM AS (SELECT PURCHASE_PRODUCT, COUNT(*) AS BM
		FROM PURCHASE, MUSICAPP_USER
		WHERE MUSICAPP_USER.SEX = 'M'
		AND MUSICAPP_USER.USER_ID = PURCHASE.USER_ID
		GROUP BY PURCHASE_PRODUCT),
BUYF AS (SELECT PURCHASE_PRODUCT, COUNT(*) AS BF
		FROM PURCHASE, MUSICAPP_USER
		WHERE MUSICAPP_USER.SEX = 'F'
		AND MUSICAPP_USER.USER_ID = PURCHASE.USER_ID
		GROUP BY PURCHASE_PRODUCT),
TAVG AS (SELECT PURCHASE_PRODUCT, AVG(MONTHS_BETWEEN(SYSDATE,MUSICAPP_USER.BORN_DATE)/12) AS AVGAGE
	FROM PURCHASE, MUSICAPP_USER
	WHERE PURCHASE.USER_ID = MUSICAPP_USER.USER_ID
	GROUP BY PURCHASE_PRODUCT)
SELECT PRODUCT.NAME AS PNAME, CATEGORY, SUM(NVL(BM,0)+NVL(BF,0)) AS BNUM, SUM(NVL(BM,0)) AS MNUM, SUM(NVL(BF,0)) AS FNUM, NVL(AVG(AVGAGE),0) AS TAVGAGE
FROM PRODUCT, BUYM, BUYF, TAVG
WHERE PRODUCT.NAME LIKE '%&제품명%'
AND PRODUCT.NUM = BUYM.PURCHASE_PRODUCT(+)
AND PRODUCT.NUM = BUYF.PURCHASE_PRODUCT(+)
AND PRODUCT.NUM = TAVG.PURCHASE_PRODUCT(+)
GROUP BY PRODUCT.NAME, CATEGORY
ORDER BY PNAME DESC
/

TTITLE OFF
CLEAR COLUMNS