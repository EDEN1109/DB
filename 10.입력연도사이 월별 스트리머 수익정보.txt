SET FEEDBACK OFF

TTITLE '연도별 스트리머 수입'
COLUMN MON HEADING '월'
COLUMN SID HEADING '스트리머ID'
COLUMN RANK HEADING '등급'
COLUMN DONATED HEADING '총 수입' FORMAT 999,999,999,999
COLUMN FEE HEADING '수수료|(%)'
COLUMN PURE HEADING '순수익' FORMAT 999,999,999,999
BREAK ON MON

WITH YINFO AS (SELECT '&년도' AS YIN FROM DUAL),
DECIDE_INFO AS (SELECT STREAMER_ID, MAX(DECIDE_DATE) KEEP (DENSE_RANK LAST ORDER BY DECIDE_DATE) AS DDATE, MAX(RANK_CATEGORY) KEEP (DENSE_RANK LAST ORDER BY DECIDE_DATE) AS RANK
		FROM DECIDE, YINFO
		WHERE TO_CHAR(DECIDE_DATE,'YYYY') <= YIN
		GROUP BY STREAMER_ID)
SELECT TO_CHAR(DONATE_DATE,'MM') AS MON, DONATE.STREAMER_ID AS SID, RANK, SUM(PAYMENT) AS DONATED, FEE, SUM(PAYMENT)*(100-FEE)/100 AS PURE
FROM DONATE, STREAMER_RANK, DECIDE_INFO, YINFO
WHERE TO_CHAR(DONATE_DATE,'YYYY') = YIN
AND DONATE.STREAMER_ID = DECIDE_INFO.STREAMER_ID
AND DECIDE_INFO.RANK = STREAMER_RANK.CATEGORY
GROUP BY TO_CHAR(DONATE_DATE,'MM'), DONATE.STREAMER_ID, RANK, FEE
ORDER BY MON
/


TTITLE OFF
CLEAR COLUMNS
CLEAR BREAK